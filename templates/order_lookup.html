{% extends "base.html" %}

{% block title %}Check Your Order - Tunnelgrain{% endblock %}

{% block content %}
<section class="section-padding">
    <div class="container">
        <div class="row justify-content-center">
            <div class="col-lg-8">
                <div class="card-modern p-5">
                    <div class="text-center mb-5">
                        <div class="mb-4">
                            <i class="fas fa-search text-primary" style="font-size: 4rem;"></i>
                        </div>
                        
                        <h2 class="fw-bold mb-3">Check Your VPN Status</h2>
                        <p class="text-muted">
                            Enter your order number to check your VPN status and time remaining.
                            No personal information is required or stored.
                        </p>
                    </div>
                    
                    <form id="orderForm" class="mb-5">
                        <div class="mb-4">
                            <label class="form-label fw-bold">Order Number</label>
                            <input type="text" 
                                   class="form-control-modern text-center text-uppercase" 
                                   id="orderNumber" 
                                   placeholder="42XXXXXX or 72XXXXXX" 
                                   style="font-family: 'Courier New', monospace; font-size: 1.5rem; letter-spacing: 2px;"
                                   maxlength="8" 
                                   required>
                            <div class="form-text text-muted mt-3">
                                <i class="fas fa-info-circle me-2"></i>
                                8-digit order number from your confirmation
                                <div class="mt-2">
                                    <small>
                                        <span class="badge bg-primary">42XXXXXX</span> = Paid VPN plans
                                        <span class="ms-2 badge bg-success">72XXXXXX</span> = Test VPN (15 min)
                                    </small>
                                </div>
                            </div>
                        </div>
                        
                        <button type="submit" class="btn-primary-custom btn-lg w-100">
                            <i class="fas fa-search me-2"></i>
                            Check Order Status
                        </button>
                    </form>
                    
                    <!-- Results Container -->
                    <div id="orderResult" style="display: none;">
                        <!-- Results will be inserted here by JavaScript -->
                    </div>
                    
                    <!-- Info Cards -->
                    <div class="row g-3 mt-5">
                        <div class="col-md-4">
                            <div class="text-center p-3">
                                <i class="fas fa-lock text-success mb-2" style="font-size: 2rem;"></i>
                                <h6 class="fw-bold">Privacy First</h6>
                                <small class="text-muted">No personal data required</small>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="text-center p-3">
                                <i class="fas fa-clock text-warning mb-2" style="font-size: 2rem;"></i>
                                <h6 class="fw-bold">Real-time Status</h6>
                                <small class="text-muted">Live expiration tracking</small>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="text-center p-3">
                                <i class="fas fa-download text-primary mb-2" style="font-size: 2rem;"></i>
                                <h6 class="fw-bold">Easy Access</h6>
                                <small class="text-muted">Re-download configs</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

<!-- Help Section -->
<section class="section-padding bg-light">
    <div class="container">
        <div class="text-center mb-5">
            <h2 class="section-title">Can't Find Your Order?</h2>
            <p class="section-subtitle">Here's how to locate your order information</p>
        </div>
        
        <div class="row g-4">
            <div class="col-lg-4">
                <div class="card-modern p-4 h-100">
                    <div class="text-center mb-3">
                        <i class="fas fa-envelope text-primary" style="font-size: 3rem;"></i>
                    </div>
                    <h5 class="fw-bold text-center mb-3">Check Your Email</h5>
                    <p class="text-muted">
                        Search your inbox for "Tunnelgrain" or check your spam folder. 
                        Your order number was sent immediately after purchase.
                    </p>
                </div>
            </div>
            
            <div class="col-lg-4">
                <div class="card-modern p-4 h-100">
                    <div class="text-center mb-3">
                        <i class="fas fa-credit-card text-success" style="font-size: 3rem;"></i>
                    </div>
                    <h5 class="fw-bold text-center mb-3">Payment Receipt</h5>
                    <p class="text-muted">
                        Check your payment receipt from Stripe. The order number 
                        appears on the payment success page.
                    </p>
                </div>
            </div>
            
            <div class="col-lg-4">
                <div class="card-modern p-4 h-100">
                    <div class="text-center mb-3">
                        <i class="fas fa-headset text-warning" style="font-size: 3rem;"></i>
                    </div>
                    <h5 class="fw-bold text-center mb-3">Need Help?</h5>
                    <p class="text-muted">
                        Can't locate your order? Contact our support team with your payment 
                        details for assistance.
                    </p>
                </div>
            </div>
        </div>
        
        <div class="text-center mt-5">
            <a href="{{ url_for('contact') }}" class="btn-secondary-custom">
                <i class="fas fa-envelope me-2"></i>
                Contact Support
            </a>
        </div>
    </div>
</section>

<!-- Order Types Information -->
<section class="section-padding">
    <div class="container">
        <div class="row justify-content-center">
            <div class="col-lg-10">
                <h3 class="text-center fw-bold mb-5">
                    <i class="fas fa-info-circle text-primary me-2"></i>
                    Order Number Types
                </h3>
                
                <div class="row g-4">
                    <div class="col-md-6">
                        <div class="card-modern p-4 h-100">
                            <h5 class="fw-bold text-primary mb-3">
                                <span class="badge bg-primary me-2">42XXXXXX</span>
                                Paid VPN Plans
                            </h5>
                            <ul class="list-unstyled mb-0">
                                <li class="mb-2">
                                    <i class="fas fa-check-circle text-success me-2"></i>
                                    Monthly ($4.99) - 30 days
                                </li>
                                <li class="mb-2">
                                    <i class="fas fa-check-circle text-success me-2"></i>
                                    Quarterly ($12.99) - 90 days
                                </li>
                                <li class="mb-2">
                                    <i class="fas fa-check-circle text-success me-2"></i>
                                    Biannual ($23.99) - 180 days
                                </li>
                                <li class="mb-2">
                                    <i class="fas fa-check-circle text-success me-2"></i>
                                    Annual ($39.99) - 365 days
                                </li>
                                <li class="mb-0">
                                    <i class="fas fa-check-circle text-success me-2"></i>
                                    Lifetime ($99.99) - Unlimited
                                </li>
                            </ul>
                        </div>
                    </div>
                    
                    <div class="col-md-6">
                        <div class="card-modern p-4 h-100">
                            <h5 class="fw-bold text-success mb-3">
                                <span class="badge bg-success me-2">72XXXXXX</span>
                                Test VPN Plans
                            </h5>
                            <ul class="list-unstyled mb-0">
                                <li class="mb-2">
                                    <i class="fas fa-clock text-warning me-2"></i>
                                    15-minute free trial
                                </li>
                                <li class="mb-2">
                                    <i class="fas fa-gift text-info me-2"></i>
                                    No payment required
                                </li>
                                <li class="mb-2">
                                    <i class="fas fa-rocket text-primary me-2"></i>
                                    Full speed access
                                </li>
                                <li class="mb-2">
                                    <i class="fas fa-mobile-alt text-secondary me-2"></i>
                                    All devices supported
                                </li>
                                <li class="mb-0">
                                    <i class="fas fa-sync text-success me-2"></i>
                                    Multiple tests allowed
                                </li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>
{% endblock %}

{% block scripts %}
<script>
document.getElementById('orderForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const orderNumber = document.getElementById('orderNumber').value.trim().toUpperCase();
    const resultDiv = document.getElementById('orderResult');
    const submitBtn = document.querySelector('button[type="submit"]');
    const originalBtnText = submitBtn.innerHTML;
    
    // Validate format
    if (!orderNumber.match(/^(42|72)[A-F0-9]{6}$/)) {
        showResult('error', 'Invalid Format', 'Please enter a valid 8-digit order number starting with "42" or "72"');
        return;
    }
    
    // Show loading state
    submitBtn.disabled = true;
    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Checking...';
    
    try {
        const response = await fetch('/check-order', {
            method: 'POST',
            headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
            body: `order_number=${orderNumber}`
        });
        
        const data = await response.json();
        
        if (data.order_found) {
            showOrderDetails(data, orderNumber);
        } else {
            showResult('warning', 'Order Not Found', 
                `Order ${orderNumber} was not found. Please check the number and try again.<br><br>
                <small>If you just placed this order, please wait a few minutes and try again.</small>`);
        }
        
    } catch (error) {
        console.error('Lookup error:', error);
        showResult('error', 'Connection Error', 
            'Unable to check order status. Please try again in a moment.');
    } finally {
        submitBtn.disabled = false;
        submitBtn.innerHTML = originalBtnText;
    }
});

function showOrderDetails(data, orderNumber) {
    const resultDiv = document.getElementById('orderResult');
    const isTest = orderNumber.startsWith('72');
    const isActive = data.status === 'active';
    
    // Determine tier badge color
    const tierColors = {
        'test': 'success',
        'monthly': 'primary',
        'quarterly': 'info',
        'biannual': 'warning',
        'annual': 'danger',
        'lifetime': 'dark'
    };
    const tierColor = tierColors[data.tier] || 'secondary';
    
    // Format creation date
    let formattedDate = 'Unknown';
    if (data.assigned_at && data.assigned_at !== 'unknown') {
        try {
            formattedDate = new Date(data.assigned_at).toLocaleString();
        } catch (e) {
            formattedDate = data.assigned_at;
        }
    }
    
    resultDiv.innerHTML = `
        <div class="card ${isActive ? 'border-success' : 'border-danger'} mb-4">
            <div class="card-header ${isActive ? 'bg-success' : 'bg-danger'} text-white">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <i class="fas fa-${isActive ? 'check-circle' : 'times-circle'} me-2"></i>
                        Order Found - ${isActive ? 'ACTIVE' : 'EXPIRED'}
                    </div>
                    <span class="badge bg-white text-dark fs-6">${orderNumber}</span>
                </div>
            </div>
            
            <div class="card-body">
                <div class="row mb-4">
                    <div class="col-md-6">
                        <h6 class="text-muted mb-1">Service Type</h6>
                        <h5 class="mb-0">
                            <span class="badge bg-${tierColor} fs-6">${data.tier_name || data.tier}</span>
                        </h5>
                    </div>
                    <div class="col-md-6">
                        <h6 class="text-muted mb-1">Time Remaining</h6>
                        <h5 class="mb-0 ${isActive ? 'text-success' : 'text-danger'}">
                            <i class="fas fa-clock me-1"></i>
                            ${data.time_remaining}
                        </h5>
                    </div>
                </div>
                
                <div class="row mb-4">
                    <div class="col-md-6">
                        <h6 class="text-muted mb-1">Server IP</h6>
                        <code class="bg-light p-2 rounded d-inline-block">${data.ip_address}</code>
                    </div>
                    <div class="col-md-6">
                        <h6 class="text-muted mb-1">Config ID</h6>
                        <code class="bg-light p-2 rounded d-inline-block">${data.config_id}</code>
                    </div>
                </div>
                
                ${isActive ? `
                    <div class="alert alert-info mb-3">
                        <i class="fas fa-info-circle me-2"></i>
                        <strong>Active VPN:</strong> Your VPN is currently active and working. 
                        If you need to re-download your files, please use your original download links 
                        or contact support for assistance.
                    </div>
                    
                    <div class="row g-2">
                        <div class="col-md-6">
                            <a href="${isTest ? '/test' : '/order'}" 
                               class="btn btn-outline-primary w-100">
                                <i class="fas fa-${isTest ? 'flask' : 'shopping-cart'} me-2"></i>
                                ${isTest ? 'Get Another Test' : 'Purchase Additional'}
                            </a>
                        </div>
                        <div class="col-md-6">
                            <a href="/contact" 
                               class="btn btn-primary w-100">
                                <i class="fas fa-envelope me-2"></i>
                                Contact Support
                            </a>
                        </div>
                    </div>
                ` : `
                    <div class="alert alert-warning mb-3">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        <strong>VPN Expired:</strong> This VPN access has expired and is no longer active.
                        ${isTest ? 
                            ' Test VPNs expire after 15 minutes. You can get another free test or purchase a plan.' :
                            ' Please purchase a new plan to continue using our VPN service.'
                        }
                    </div>
                    
                    <div class="row g-2">
                        <div class="col-md-6">
                            <a href="${isTest ? '/test' : '/order'}" 
                               class="btn btn-success w-100">
                                <i class="fas fa-${isTest ? 'flask' : 'shopping-cart'} me-2"></i>
                                ${isTest ? 'Get New Test' : 'Purchase New Plan'}
                            </a>
                        </div>
                        <div class="col-md-6">
                            <a href="/contact" 
                               class="btn btn-outline-primary w-100">
                                <i class="fas fa-envelope me-2"></i>
                                Contact Support
                            </a>
                        </div>
                    </div>
                `}
            </div>
            
            <div class="card-footer bg-light">
                <div class="row text-muted">
                    <div class="col-md-6">
                        <small>
                            <i class="fas fa-calendar me-1"></i>
                            Created: ${formattedDate}
                        </small>
                    </div>
                    <div class="col-md-6 text-md-end">
                        <small>
                            ${data.timer_started ? 
                                '<i class="fas fa-check-circle text-success me-1"></i>Timer Active' : 
                                '<i class="fas fa-clock text-muted me-1"></i>Timer Status Unknown'
                            }
                        </small>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    resultDiv.style.display = 'block';
    resultDiv.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
}

function showResult(type, title, message) {
    const resultDiv = document.getElementById('orderResult');
    const alertClass = {
        'success': 'alert-success',
        'error': 'alert-danger',
        'warning': 'alert-warning',
        'info': 'alert-info'
    }[type] || 'alert-secondary';
    
    const iconType = {
        'success': 'check-circle',
        'error': 'exclamation-circle',
        'warning': 'exclamation-triangle',
        'info': 'info-circle'
    }[type] || 'info-circle';
    
    resultDiv.innerHTML = `
        <div class="alert ${alertClass} mb-4">
            <h5 class="alert-heading mb-2">
                <i class="fas fa-${iconType} me-2"></i>
                ${title}
            </h5>
            <div>${message}</div>
        </div>
    `;
    
    resultDiv.style.display = 'block';
    resultDiv.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
}

// Auto-format and validate input
document.getElementById('orderNumber').addEventListener('input', function(e) {
    let value = e.target.value.toUpperCase().replace(/[^A-F0-9]/g, '');
    if (value.length > 8) value = value.substring(0, 8);
    e.target.value = value;
    
    // Visual validation feedback
    if (value.length === 8) {
        const isValid = value.match(/^(42|72)[A-F0-9]{6}$/);
        e.target.classList.toggle('is-valid', isValid);
        e.target.classList.toggle('is-invalid', !isValid);
    } else {
        e.target.classList.remove('is-valid', 'is-invalid');
    }
});

// Clear results when input gains focus
document.getElementById('orderNumber').addEventListener('focus', function() {
    const resultDiv = document.getElementById('orderResult');
    if (resultDiv.style.display !== 'none') {
        resultDiv.style.display = 'none';
    }
});

// Copy functionality for code elements
document.addEventListener('click', function(e) {
    if (e.target.tagName === 'CODE') {
        const text = e.target.textContent;
        if (navigator.clipboard) {
            navigator.clipboard.writeText(text).then(() => {
                const original = e.target.innerHTML;
                e.target.innerHTML = '<i class="fas fa-check text-success"></i> Copied!';
                e.target.style.cursor = 'default';
                setTimeout(() => {
                    e.target.innerHTML = original;
                    e.target.style.cursor = 'pointer';
                }, 1500);
            }).catch(() => {
                // Fallback for older browsers
                e.target.style.backgroundColor = '#d4edda';
                setTimeout(() => {
                    e.target.style.backgroundColor = '';
                }, 1000);
            });
        }
    }
});

// Add hover effect to clickable code elements
document.addEventListener('DOMContentLoaded', function() {
    const style = document.createElement('style');
    style.textContent = `
        code:hover {
            cursor: pointer;
            background-color: #e9ecef !important;
            transition: background-color 0.2s ease;
        }
    `;
    document.head.appendChild(style);
});
</script>
{% endblock %}